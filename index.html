<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MPA Europe map platform</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
<style> @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap'); #title-block-header { display: none;} #quarto-content>* {padding-top: 0px;} </style>


</head>

<body class="fullcontent">

<div class="page-layout-custom">  

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">MPA Europe map platform</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- Add the top grid (map on the left, tabs on the right) --->
<div class="grid column-screen gridalt">
<div class="g-col-md-8 g-col-12">
<div class="cell">
<div class="cell-output-display">
<style type="text/css">/* css styles */

/* Grid style */
.colordiv {
  background-color: #f6f6f6;
  position: relative;
}

.gridalt {
 gap: 0;
}
.gridaltsm {
 gap: 0.05;
}

/* Tabs */
.nav-tabs {
    border-bottom: 0px solid #ec279b;
    background: #168aad;
}

.nav-tabs .nav-item {
    margin-top: 0;
    border: 0px;
    border-radius: 0;
}

a#tabset-1-1-tab {
    background: #184e77;
}
a#tabset-1-2-tab {
    background: #1e6091;
}
a#tabset-1-3-tab {
    background: #1a759f;
}
a#tabset-1-4-tab {
    background: #168aad;
}

.nav-link {
    display: block;
    padding: .5rem 1rem;
    color: #ffffff;
    text-decoration: none;
    font-size: smaller;
    font-weight: 600;
    -webkit-text-decoration: none;
    -moz-text-decoration: none;
    -ms-text-decoration: none;
    -o-text-decoration: none;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out
}

.nav-tabs .nav-link {
    margin-bottom: 0px;
    background: none;
    border: 0px;
    border-radius: 0;
}

.nav-tabs .nav-link.active,.nav-tabs .nav-item.show .nav-link {
    color: #184e77;
    background-color: #f6f6f6 !important;
    border: 0px;
    border-radius: 0;
}

.nav-link:hover,.nav-link:focus {
    color: #57D8FF;
    border: 0px;
    border-radius: 0;
}

.tab-content {
    margin-top: 0px;
    border-left: #dee2e6 0px solid;
    border-right: #dee2e6 0px solid;
    border-bottom: #dee2e6 0px solid;
    margin-left: 0;
    padding: 0.2em;
    margin-bottom: 0.2em
}

/* Input div classes */
.itdiv_class .shiny-input-select {
   font-style: italic;
}

.scenario_class {
  font-size: 11px;
  margin: 0;
}

.scenario_class .selectize-input {
  font-size: 11px;
  margin: 0;
}

.scenario_class .selectize-dropdown,
.scenario_class .selectize-input,
.scenario_class .selectize-input input {
  font-size: 11px;
  margin: 0;
}

.bottom-container {
  position: absolute;
  bottom: 0;
  margin-bottom: 6em;
  margin-right: 1em;
}


/* Selectize controlers */
.selectize-control.single .selectize-input:after {
  border-color: #cccccc transparent transparent transparent;
}
.selectize-control.single .selectize-input.dropdown-active:after {
  border-color: transparent transparent #cccccc transparent;
}
.selectize-input {
    border: 1px solid #cccccc;
    background-color: #00000000 !important;
    border-radius: 0.2em;
}


/* Others */
.tabdiv {
    min-height: 500px;
    margin-left: 0.5em;
    margin-right: 0.5em;
    margin-top: 0.5em;
}

.material-symbols-outlined {
  display: inline-flex;
  vertical-align: top;
  font-variation-settings:
  'FILL' 0,
  'wght' 400,
  'GRAD' 0,
  'opsz' 24
}

/* Titles and context */
#species_title {
  margin-top: 0.3em;
  color: #184e77;
  font-size: 25px;
  font-weight: 600;
  font-style: italic;
}

#thermal_species_title {
  margin-top: 0.3em;
  color: #1e6091;
  font-size: 25px;
  font-weight: 600;
  font-style: italic;
}

#habitat_title {
  margin-top: 0.3em;
  color: #1a759f;
  font-size: 25px;
  font-weight: 600;
  font-style: italic;
}

#diversity_title {
  margin-top: 0.3em;
  color: #168aad;
  font-size: 25px;
  font-weight: 600;
  font-style: italic;
}

.context_info {
  margin-top: 0.3em;
  color: #545454;
  font-size: 12px;
}

.context-icons {
  color: #545454;
  font-size: 11px;
  position: absolute;
  bottom: 0;
  margin-bottom: 1em;
}

.context-icons-box {
  cursor: pointer;
  padding: 5px;
}


/* Sections */
.body-section {
  margin-right: 2em;
  margin-left: 2em;
  margin-top: 2em;
}

.body-title {
  margin-top: 0.3em;
  color: #184e77;
  font-size: 22px;
  font-weight: 600;
}

.body-text {
  margin-top: 0.3em;
  color: #545454;
  font-size: 14px;
}

.methods-div {
  margin-top: 2em;
  padding: 2em;
  padding-top: 1em;
  color: #545454;
  background-color: #f6f6f6;
}

.footer-div {
  margin-top: 0em;
  margin-bottom: -2em;
  font-size: 12px;
  padding: 2em;
  padding-top: 1em;
  color: #ffffff;
  background-color: #184e77;
}

#footer-links a {
  font-size: 12px;
  color: #B2EDFA;
  text-decoration: none;
}

#footer-credits {
  font-size: 9px;
}



/* Leaflet */
.leaflet-touch .leaflet-bar {
    border: none;
    border-bottom: 0px;
}

.leaflet-touch .leaflet-control-layers {
  border: none;
  border-bottom: 0px;
}

.leaflet-touch .leaflet-bar a:first-child {
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
}
.leaflet-touch .leaflet-bar a:last-child {
    border-bottom-left-radius: 6px;
    border-bottom-right-radius: 6px;
}
    
.leaflet-bar button:last-of-type {
    border-bottom-left-radius: 6px;
    border-bottom-right-radius: 6px;
    border-bottom: none;
}
.leaflet-bar button:first-of-type {
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
}

.leaflet-bar a, .leaflet-bar a:hover {
  border-bottom: 0px;
}

a#leafletEasyPrint {
  border-bottom-left-radius: 6px !important;
  border-bottom-right-radius: 6px !important;
  border-top-left-radius: 6px !important;
    border-top-right-radius: 6px !important;
  /*background-color: rgb(0,0,0,0);*/
}

a:hover#leafletEasyPrint {
  border-bottom-left-radius: 6px !important;
  border-bottom-right-radius: 6px !important;
  border-top-left-radius: 6px !important;
    border-top-right-radius: 6px !important;
  /*background-color: rgb(0,0,0,0);*/
}

.easyPrintHolder .easyPrintSizeMode:last-child a {
  border-bottom-left-radius: 6px !important;
  border-bottom-right-radius: 6px !important;
  border-top-left-radius: 6px !important;
    border-top-right-radius: 6px !important;
}


a.leaflet-buttons-control-button {
  border-bottom-left-radius: 6px !important;
  border-bottom-right-radius: 6px !important;
  border-top-left-radius: 6px !important;
    border-top-right-radius: 6px !important;
}

/*
a.A4Portrait, a.A4Landscape, a.CurrentSize {
  background-color: rgb(0,0,0,0);
}
*/

.graphDiv {
  display: none;
  position: absolute;
  top: 50px;
  right: 20px;
  z-index: 1000;
  background-color: white;
  padding: 10px;
  border-radius: 8px;
  color: grey;
  font-size: 10px;
}

.graphDivButton {
  position: absolute;
  top: 5px;
  right: 5px;
  border: none;
  background-color: transparent;
  font-size: 18px; 
  cursor: pointer;
}

.checkDiv {
  position: absolute;
  bottom: 1px;
  left: 50px;
  z-index: 900;
  padding: 1px;
  border-radius: 8px;
  color: white;
  font-size: 12px;
}

.sideDiv {
  position: absolute;
  bottom: 45px;
  left: 1%;
  z-index: 1000;
  padding: 2px;
  border-radius: 3px;
  color: #184e77;
  background-color: rgba(255, 255, 255, 0.7);
  font-size: 12px;
  font-weight: bold;
}

.sideDivRight {
  position: absolute;
  bottom: 45px;
  right: 1%;
  z-index: 1000;
  padding: 2px;
  border-radius: 3px;
  color: #184e77;
  background-color: rgba(255, 255, 255, 0.7);
  font-size: 12px;
  font-weight: bold;
}


/* Waiting div */
.busyDiv {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 3000;
  background-color: white;
  color: #545454;
  font-size: 12px;
}

a {
  text-decoration: none !important;
  color: #168aad;
}


/* Buttons */
.extra-button {
   display: inline-block;
   padding: 5px;
   border: 2px solid #184e77; /* Blue outline */
   background-color: transparent; /* No background */
   color: #184e77; /* Text color same as outline */
   font-weight: bold; /* Bold text */
   text-align: center; /* Center the text */
   vertical-align: middle; /* Center the text vertically */
   transition: all 0.3s ease; /* Fading animation on hover */
   cursor: pointer; /* Pointer cursor on hover */
   font-size: 14px;
}

.extra-button:hover {
    background-color: transparent; /* Background color on hover */
    border: 2px solid #168aad; /* Blue outline */
    color: #168aad; /* Text color on hover */
}

.download-button {
   display: inline-block;
   padding: 5px;
   border: 2px solid #0F7861; /* Blue outline */
   background-color: transparent; /* No background */
   color: #0F7861; /* Text color same as outline */
   font-weight: bold; /* Bold text */
   text-align: center; /* Center the text */
   vertical-align: middle; /* Center the text vertically */
   transition: all 0.3s ease; /* Fading animation on hover */
   cursor: pointer; /* Pointer cursor on hover */
   font-size: 14px;
}

.download-button:hover {
    background-color: transparent; /* Background color on hover */
    border: 2px solid #14BD99; /* Blue outline */
    color: #14BD99; /* Text color on hover */
}

.extra-buttons-cont {
    display: flex;
    justify-content: center; /* Center the buttons horizontally */
    gap: 50px; /* Space between buttons */
}</style>
</div>
<div class="cell-output-display">
<script>document.addEventListener('DOMContentLoaded', function() {
    // Get tabs elements
    const tabs = document.querySelectorAll('.nav-link');
  
    // Get divs with a specific pattern (class 'body-title')
    const divs = document.querySelectorAll('.body-title');

    // Get the div whose background color will change
    const colorChangingDiv = document.getElementById('footer-div');
  
    // Loop through tabs
    tabs.forEach(function(tab) {
      // Add event listener for tab click
      tab.addEventListener('click', function() {
        // Check if tab is active
        if (tab.classList.contains('active')) {
          // Change text color of divs based on the active tab
          if (tab.id === 'tabset-1-1-tab') {
            divs.forEach(function(div) {
              div.style.color = '#184e77'; // Change text color to red for Tab 1
            });
            colorChangingDiv.style.backgroundColor = '#184e77'; // Change to desired color for Tab 1

            // Change value in the app
            var active_tab = {id: "species", nonce: Math.random()};
            Shiny.onInputChange("jsValue", active_tab)

          } else if (tab.id === 'tabset-1-2-tab') {
            divs.forEach(function(div) {
              div.style.color = '#1e6091'; // Change text color to blue for Tab 2
            });
            colorChangingDiv.style.backgroundColor = '#1e6091'; // Change to desired color for Tab 2

            // Change value in the app
            var active_tab = {id: "thermal", nonce: Math.random()};
            Shiny.onInputChange("jsValue", active_tab)

          } else if (tab.id === 'tabset-1-3-tab') {
            divs.forEach(function(div) {
              div.style.color = '#1a759f'; 
            });
            colorChangingDiv.style.backgroundColor = '#1a759f'; 
            
            // Change value in the app
            var active_tab = {id: "habitat", nonce: Math.random()};
            Shiny.onInputChange("jsValue", active_tab)
            
          } else if (tab.id === 'tabset-1-4-tab') {
            divs.forEach(function(div) {
              div.style.color = '#168aad'; 
            });
            colorChangingDiv.style.backgroundColor = '#168aad'; 
            
            // Change value in the app
            var active_tab = {id: "diversity", nonce: Math.random()};
            Shiny.onInputChange("jsValue", active_tab)
          }
        }
      });
    });
  });
  
  Shiny.addCustomMessageHandler('showContext', hideGraphDiv);
  Shiny.addCustomMessageHandler('removeContext', hideGraphDivOn);
  
  function hideGraphDiv(message) {
    var graphDiv = document.getElementById('graphDiv');
      if (graphDiv.style.display === 'none' || graphDiv.style.display === '') {
        graphDiv.style.display = 'block';
      } else {
        graphDiv.style.display = 'none';
      }
  };
  
  function hideGraphDivOn(message) {
    var graphDiv = document.getElementById('graphDiv');
      if (graphDiv.style.display === 'block') {
        graphDiv.style.display = 'none';
      }
  };
  
  // Flushed mask
  //Shiny.addCustomMessageHandler('enableMask', enableMaskFun);
  
  //function enableMaskFun(message) {
  //  Shiny.onInputChange("enableMaskJS", message)
  //}
  /*$(document).on('shiny:value', function(event) {
    if(event.name == 'mainMap'){
      var message = {id: event.name, nonce: Math.random()};
      Shiny.onInputChange("enableMaskJS", message);
    }
  });*/
  
  //TEMPORARY!!!
  Shiny.addCustomMessageHandler('backToTab', backTotabtemp);
  function backTotabtemp(message) {
    
    var tab1 = document.getElementById('tabset-1-1-tab');
    var tab2 = document.getElementById('tabset-1-2-tab');
    var tab3 = document.getElementById('tabset-1-3-tab');
    var tab4 = document.getElementById('tabset-1-4-tab');
    
    // Set the first tab as active
    tab1.classList.add('active');
    tab1.setAttribute('aria-selected', 'true');

    // Remove active state from the second tab
    //tab2.classList.remove('active');
    //tab2.setAttribute('aria-selected', 'false');
    tab3.classList.remove('active');
    tab3.setAttribute('aria-selected', 'false');
    tab4.classList.remove('active');
    tab4.setAttribute('aria-selected', 'false');
    
  };</script>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="busyDiv" data-display-if="$('html').attr('class')=='shiny-busy'">Loading/processing data...<i class="fa fa-spinner fa-pulse fa-fw" style="color:#1a759f"></i></div>
</div>
<div class="cell-output-display">
<div style="position: relative;">
<div class="leaflet html-widget html-widget-output shiny-report-size html-fill-item" id="mainMap" style="width:100%;height:600px;"></div>
<div id="graphDiv" class="graphDiv">
<button onclick="hideGraphDiv()" class="graphDivButton">
<span class="material-symbols-outlined">close</span>
</button>
<div style="width: 200px; height: 300px;">
<div>
<div id="contextMapText" class="shiny-html-output"></div>
<div class="shiny-plot-output html-fill-item" id="contextMap" style="width:100%;height:400px;"></div>
</div>
</div>
</div>
<div id="checkDiv" class="checkDiv">
<div class="shiny-panel-conditional" data-display-if="input.scenarioSelect != 'Current'" data-ns-prefix="">
<div id="sideside_box" class="sideside_class">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="sideSelect" type="checkbox" class="shiny-input-checkbox">
<span>Split map viewer</span>
</label>
</div>
</div>
</div>
</div>
</div>
<div id="sideDiv" class="sideDiv">
<div class="shiny-panel-conditional" data-display-if="input.sideSelect == true" data-ns-prefix="">
<div id="sidetext_box" class="sidetext_class">Current</div>
</div>
</div>
<div id="sideDivRight" class="sideDivRight">
<div class="shiny-panel-conditional" data-display-if="input.sideSelect == true" data-ns-prefix="">
<div id="sidetext_box_r" class="sidetext_class_r">Future</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-md-4 g-col-12 colordiv">
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">SPECIES</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">THERMAL RANGE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">HABITAT</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">DIVERSITY</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="tabdiv">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="groupSelect-label" for="groupSelect">Select group</label>
<div>
<select id="groupSelect" class="shiny-input-select"><option value="All" selected="">All</option>
<option value="Others">Others</option></select>
<script type="application/json" data-for="groupSelect" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="italic_div" class="itdiv_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="speciesSelect-label" for="speciesSelect">Search species</label>
<div>
<select class="shiny-input-select form-control" id="speciesSelect"><option value="" selected="">Select one</option></select>
<script type="application/json" data-for="speciesSelect">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
<div class="cell-output-display">
<div id="species_title" class="rtitle_class">
<div id="selectedSpecies" class="shiny-text-output"></div>
</div>
</div>
<div class="cell-output-display">
<div id="context_info" class="context_info">
<div id="contextSpecies" class="shiny-html-output"></div>
</div>
</div>
</div>
<div class="bottom-container">
<div class="grid gridaltsm">
<div class="g-col-5">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="modelSelect-label" for="modelSelect">Model</label>
<div>
<select id="modelSelect" class="shiny-input-select"><option value="maxnet" selected="">MAXENT</option>
<option value="rf_classification_ds">Random Forest</option>
<option value="xgboost">XGBoost</option>
<option value="glm">GLM</option>
<option value="ensemble">Ensemble</option></select>
<script type="application/json" data-for="modelSelect" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-4">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="shiny-panel-conditional" data-display-if="input.speciesSelect != ''" data-ns-prefix="">
<div id="scenario_box" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="scenarioSelect-label" for="scenarioSelect">Scenario</label>
<div>
<select id="scenarioSelect" class="shiny-input-select"><option value="Current" selected="">Current</option>
<option value="ssp126">SSP1</option>
<option value="ssp245">SSP2</option>
<option value="ssp370">SSP3</option>
<option value="ssp460">SSP4</option>
<option value="ssp585">SSP5</option></select>
<script type="application/json" data-for="scenarioSelect" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-3">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="shiny-panel-conditional" data-display-if="input.scenarioSelect != 'Current'" data-ns-prefix="">
<div id="scenario_box" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="periodSelect-label" for="periodSelect">Period</label>
<div>
<select id="periodSelect" class="shiny-input-select"><option value="2050" selected="">2050</option>
<option value="2100">2100</option></select>
<script type="application/json" data-for="periodSelect" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="context-icons">
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-download" aria-label="download"></i> DOWNLOAD THE FILE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-brands fa-github" aria-label="github"></i> ACCESS THE CODE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-play" aria-label="play"></i> RUN THE MODEL
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="tabdiv">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="groupSelectThermal-label" for="groupSelectThermal">Select group</label>
<div>
<select id="groupSelectThermal" class="shiny-input-select"><option value="All" selected="">All</option>
<option value="Others">Others</option></select>
<script type="application/json" data-for="groupSelectThermal" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="italic_div_thermal" class="itdiv_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="speciesSelectThermal-label" for="speciesSelectThermal">Search species</label>
<div>
<select class="shiny-input-select form-control" id="speciesSelectThermal"><option value="" selected="">Select one</option></select>
<script type="application/json" data-for="speciesSelectThermal">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
<div class="cell-output-display">
<div id="thermal_species_title" class="rtitle_class">
<div id="selectedSpeciesThermal" class="shiny-text-output"></div>
</div>
</div>
<div class="cell-output-display">
<div id="context_info_thermal" class="context_info">
<div id="contextSpeciesThermal" class="shiny-html-output"></div>
</div>
</div>
</div>
<div class="bottom-container">
<div class="grid gridaltsm">
<div class="g-col-6">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_thermal" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="scenarioSelectThermal-label" for="scenarioSelectThermal">Scenario</label>
<div>
<select id="scenarioSelectThermal" class="shiny-input-select"><option value="Current" selected="">Current</option>
<option value="ssp126">SSP1</option>
<option value="ssp245">SSP2</option>
<option value="ssp370">SSP3</option>
<option value="ssp460">SSP4</option>
<option value="ssp585">SSP5</option></select>
<script type="application/json" data-for="scenarioSelectThermal" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-6">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_thermal" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="periodSelectThermal-label" for="periodSelectThermal">Period</label>
<div>
<select id="periodSelectThermal" class="shiny-input-select"><option value="2050" selected="">2050</option>
<option value="2100">2100</option></select>
<script type="application/json" data-for="periodSelectThermal" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="context-icons">
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-download" aria-label="download"></i> DOWNLOAD THE FILE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-brands fa-github" aria-label="github"></i> ACCESS THE CODE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-play" aria-label="play"></i> RUN THE MODEL
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="tabdiv">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="groupSelectHabitat-label" for="groupSelectHabitat">Select group</label>
<div>
<select id="groupSelectHabitat" class="shiny-input-select"><option value="All" selected="">All</option></select>
<script type="application/json" data-for="groupSelectHabitat" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="habitatSelect-label" for="habitatSelect">Select habitat</label>
<div>
<select id="habitatSelect" class="shiny-input-select"><option value="test" selected="">test</option></select>
<script type="application/json" data-for="habitatSelect" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display">
<div id="habitat_title" class="rtitle_class">
<div id="selectedHabitat" class="shiny-text-output"></div>
</div>
</div>
<div class="cell-output-display">
<div id="context_info_hab" class="context_info">
<div id="contextHabitat" class="shiny-text-output"></div>
</div>
</div>
</div>
<div class="bottom-container">
<div class="grid gridaltsm">
<div class="g-col-6">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_habitat" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="scenarioSelectHabitat-label" for="scenarioSelectHabitat">Scenario</label>
<div>
<select id="scenarioSelectHabitat" class="shiny-input-select"><option value="Current" selected="">Current</option>
<option value="ssp126">SSP1</option>
<option value="ssp245">SSP2</option>
<option value="ssp370">SSP3</option>
<option value="ssp460">SSP4</option>
<option value="ssp585">SSP5</option></select>
<script type="application/json" data-for="scenarioSelectHabitat" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-6">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_thermal" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="periodSelectHabitat-label" for="periodSelectHabitat">Period</label>
<div>
<select id="periodSelectHabitat" class="shiny-input-select"><option value="2050" selected="">2050</option>
<option value="2100">2100</option></select>
<script type="application/json" data-for="periodSelectHabitat" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="context-icons">
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-download" aria-label="download"></i> DOWNLOAD THE FILE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-brands fa-github" aria-label="github"></i> ACCESS THE CODE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-play" aria-label="play"></i> RUN THE MODEL
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="tabdiv">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="habitatSelect-label" for="habitatSelect">Select metric</label>
<div>
<select id="habitatSelect" class="shiny-input-select"><option value="Richness" selected="">Richness</option>
<option value="E50">E50</option></select>
<script type="application/json" data-for="habitatSelect" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display">
<div id="diversity_title" class="rtitle_class">
<div id="selectedMetric" class="shiny-text-output"></div>
</div>
</div>
<div class="cell-output-display">
<div id="context_info_div" class="context_info">
<div id="contextMetric" class="shiny-text-output"></div>
</div>
</div>
</div>
<div class="bottom-container">
<div class="grid gridaltsm">
<div class="g-col-5">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_diversity" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="modelSelectDiversity-label" for="modelSelectDiversity">Model</label>
<div>
<select id="modelSelectDiversity" class="shiny-input-select"><option value="maxnet" selected="">MAXENT</option>
<option value="rf_classification_ds">Random Forest</option>
<option value="xgboost">XGBoost</option>
<option value="glm">GLM</option>
<option value="ensemble">Ensemble</option></select>
<script type="application/json" data-for="modelSelectDiversity" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-4">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_diversity" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="scenarioSelectDiversity-label" for="scenarioSelectDiversity">Scenario</label>
<div>
<select id="scenarioSelectDiversity" class="shiny-input-select"><option value="Current" selected="">Current</option>
<option value="ssp126">SSP1</option>
<option value="ssp245">SSP2</option>
<option value="ssp370">SSP3</option>
<option value="ssp460">SSP4</option>
<option value="ssp585">SSP5</option></select>
<script type="application/json" data-for="scenarioSelectDiversity" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="g-col-3">
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div id="scenario_box_diversity" class="scenario_class">
<div class="form-group shiny-input-container">
<label class="control-label" id="periodSelectDiversity-label" for="periodSelectDiversity">Period</label>
<div>
<select id="periodSelectDiversity" class="shiny-input-select"><option value="2050" selected="">2050</option>
<option value="2100">2100</option></select>
<script type="application/json" data-for="periodSelectDiversity" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="context-icons">
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-download" aria-label="download"></i> DOWNLOAD THE FILE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-brands fa-github" aria-label="github"></i> ACCESS THE CODE
</div>
<div class="context-icons-box" onclick="location.href='https://obis.org';">
<i class="fa-solid fa-play" aria-label="play"></i> RUN THE MODEL
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- HERE STARTS THE SECOND SECTION - GRAPHS, AND ETC -->
<div class="body-section">
<div class="grid">

<!-- Table 1 --->
<div class="g-col-md-6 g-col-12">
<p></p><div id="table1-title" class="body-title"> <div id="tableATitle" class="shiny-text-output"></div> </div><p></p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-widget-output shiny-report-size html-fill-item" id="tableA" style="width:100%;height:auto;"></div>
</div>
</div>
</div>
<!-- Graphic 1 -->
<div class="g-col-md-6 g-col-12">
<p></p><div id="graph-title" class="body-title"> <div id="graphTitle" class="shiny-text-output"></div> </div><p></p>
<div class="cell">
<div class="cell-output-display">
<div class="plotly html-widget html-widget-output shiny-report-size shiny-report-theme html-fill-item" id="plotA" style="width:100%;height:400px;"></div>
</div>
</div>
</div>

<!-- Table 2 --->
<div class="g-col-md-6 g-col-12">
<p></p><div id="table1-title" class="body-title"> <div id="tableBTitle" class="shiny-text-output"></div> </div><p></p>
<div class="cell">
<div class="cell-output-display">

<div class="datatables html-widget html-widget-output shiny-report-size html-fill-item" id="tableB" style="width:100%;height:auto;"></div>
</div>
</div>
</div>
<!-- Text 1 -->
<div class="g-col-md-6 g-col-12">
<p></p><div id="text-title" class="body-title"> <div id="textTitle" class="shiny-text-output"></div> </div><p></p>
<p></p><div id="text-title" class="body-text"> <div id="textModel" class="shiny-text-output"></div> </div><p></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="shiny-panel-conditional" data-display-if="input.speciesSelect !== '' &amp;&amp; (input.jsValue?.id ?? 'species') === 'species'" data-ns-prefix="">
<div>
<br>
<br>
<div id="extraButtons" class="extra-buttons-cont">
<button class="btn btn-default action-button extra-button" id="extraButton" type="button">
<i class="fas fa-layer-group" role="presentation" aria-label="layer-group icon"></i>
Show additional information
</button>
<a id="downloadSpeciesReport" class="btn btn-default shiny-download-link download-button" href="" target="_blank" download="">
<i class="fas fa-download" role="presentation" aria-label="download icon"></i>
Download species report
</a>
</div>
<br>
</div>
</div>
</div>
</div>
<!-- Extra info section -->
<div class="grid">

<!-- Table EXTRA --->
<div class="g-col-md-4 g-col-12">
<div class="cell">
<div class="cell-output-display">
<div class="shiny-panel-conditional" data-display-if="input.extraButton != 0 &amp;&amp; input.extraButton % 2 != 0" data-ns-prefix="">
<div class="shiny-plot-output html-fill-item" id="extraPlotA" style="width:100%;height:600px;"></div>
<div>
The K-function is a tool that can be used to assess the dependence between locations at different distances. The L-function transform the K-function to a straight line and makes interpretation easier. Both tools can be used to assess the clustering of the points. To know more
<a href="https://www.paulamoraga.com/book-spatial/the-k-function.html#the-k-function">read this article.</a>
</div>
</div>
</div>
</div>
</div>
<!-- Graphic EXTRA -->
<div class="g-col-md-8 g-col-12">
<div class="cell">
<div class="cell-output-display">
<div class="shiny-panel-conditional" data-display-if="input.extraButton != 0 &amp;&amp; input.extraButton % 2 != 0" data-ns-prefix="">
<div class="shiny-plot-output html-fill-item" id="extraPlotB" style="width:100%;height:600px;"></div>
<div>
The SHAPE is a new method of estimating model extrapolation. The higher the value of the SHAPE statistic, the higher is the extrapolation at that particular area. To know more
<a href="https://doi.org/10.1111/ecog.06992">read this article.</a>
MESS also enable to see the areas where the model is extrapolating when making predictions. Areas with values different than 0 depict extrapolation. The value shows how many variables are causing the extrapolation in that cell. To learn more about MESS
<a href="https://doi.org/10.1111/j.2041-210X.2010.00036.x">read this article.</a>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- HERE STARTS THE METHODS SECTION -->
<div class="methods-div">
<section id="how-models-were-created" class="level2">
<h2 data-anchor-id="how-models-were-created">How models were created?</h2>
<p>Models were created using a point-process framework. Details on the modelling framework adopted by MPA Europe, including the full documentation are available <a href="https://iobis.github.io/mpaeu_docs/">in this link.</a></p>
</section>
<section id="how-should-i-use-this-information" class="level2">
<h2 data-anchor-id="how-should-i-use-this-information">How should I use this information?</h2>
<p>Species Distribution Models (SDMs) provide valuable insights for both research and conservation efforts. These maps depict the relative and potential suitability of habitats for a particular species, aiding researchers and conservationists in understanding where a species could potentially occur. It is important to note that SDMs show suitability rather than presence, meaning the species may not actually occur throughout the entire extent indicated on the map. Additionally, there is inherent uncertainty associated with all SDM maps, stemming from various factors such as data quality, model assumptions, and environmental variability. Therefore, while SDMs offer valuable information, their results should be interpreted critically, considering the limitations and uncertainties associated with the models.</p>
</section>
</div>
<!-- HERE STARTS THE FOOTER -->
<div id="footer-div" class="footer-div">
<section id="mpa-europe-project" class="level2">
<h2 data-anchor-id="mpa-europe-project">MPA Europe project</h2>
<p>Using a holistic range of measures that include the range of biodiversity from species to ecosystems, including habitats, areas will be prioritised using systematic conservation planning software. This enables alternative weighting of variables and multiple scenarios and thus support wider marine spatial planning.</p>
<div class="grid">
<div id="footer-links" class="g-col-md-3 g-col-12">
<section id="explore-more" class="level3">
<h3 data-anchor-id="explore-more">Explore more</h3>
<p><a href="https://mpa-europe.eu/"><span class="material-symbols-outlined" style="font-size: 12px; vertical-align: middle !important;">chevron_right</span>MPA Europe</a><br>
<a href="https://obis.org"><span class="material-symbols-outlined" style="font-size: 12px; vertical-align: middle !important;">chevron_right</span>OBIS</a></p>
<p>Product created by the <a href="https://obis.org">Ocean Biodiversity Information System</a></p>
<p><img src="www/obis_logo.png" class="img-fluid" style="width:80.0%"></p>
</section>
</div>
<div id="footer-credits" class="g-col-md-9 g-col-12">
<section id="support" class="level3">
<h3 data-anchor-id="support">Support</h3>
<p>Grant Agreement 101059988 – MPA Europe | MPA Europe project has been approved under HORIZON-CL6-2021-BIODIV-01-12 — Improved science based maritime spatial planning and identification of marine protected areas.</p>
<p>Co-funded by the European Union. Views and opinions expressed are however those of the authors only and do not necessarily reflect those of the European Union or UK Research and Innovation. Neither the European Union nor the granting authority can be held responsible for them.</p>
<p><img src="www/euuk_logo.png" class="img-fluid" style="width:50.0%"></p>
</section>
</div>
</div>
<div style="font-size: 8px; color: white; text-align: center;">
All data shown in this website is under a CC-0 licence.
</div>
</section>
</div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
# Load needed packages ----
library(leaflet)
library(leafem)
library(leafpm)
library(leaflet.extras2)
library(leaflet.providers)
# Add maps and content ----
library(dplyr)
library(terra)
library(plotly)
library(ggplot2)
library(spatstat.explore)
library(shinyalert)
#library(stars)
# Source functions
source("functions.R")

# Settings ----
debug = T # Set here to TRUE to see debugging messages

# Create debug function
mdebug <- function(text, toprint = debug) {
  if (toprint) {
    message(text)
  }
  return(invisible(NULL))
}

# Create leaflet object ----
m <- leaflet() %>% 
  addTiles(group = "Open Street Maps", layerId = "baseid") %>%
  addProviderTiles(providers$CartoDB.Positron, group = "CartoDB") %>%
  addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB Dark") %>%
  addLayersControl(
    overlayGroups = c("Points"),
    baseGroups = c("Open Street Maps", "CartoDB", "CartoDB Dark"),
    options = layersControlOptions(collapsed = T),
    position = "bottomright"
  ) %>%
  addEasyprint(options = easyprintOptions(
    title = 'Print map',
    position = 'bottomleft',
    exportOnly = TRUE)) %>%
  setView(lng = 0.35, lat = 65, zoom = 3)

# Add title/text species
speciesinfo <- read.csv("data/all_splist_20231017.csv")
</script>
 
<script type="application/shiny-prerendered" data-context="server">
# This is the code that is executed on the server

# TODO: 
# change selectInput for server-side selectize: https://shiny.posit.co/r/articles/build/selectize/
# improve code (clean up)
# Ask Pieter to solve the problem with mask time


##### PART 1 - SPECIES ######

# Set reactive for the map ----
current_map <- reactiveVal()


# Start by ploting/printing placeholders ----
output$mainMap <- renderLeaflet({
  mdebug("Rendering Leaflet map")
  current_map()})

output$tableATitle <- renderText({ "Select a map to start" })


# Create species selectize ----
available_species <- list.files("data/maps/")
available_species_int <- list.files(paste0("data/maps/", available_species))
available_species <- available_species[which(grepl("inteval", available_species_int))]
available_species_int <- list.files(paste0("data/maps/", available_species, "/model=inteval"), pattern = "log.json")
available_ids <- unlist(regmatches(available_species_int, gregexpr("taxonid=\\d+_", available_species_int)))
available_ids <- gsub("_", "", gsub("taxonid=", "", available_ids))
available_species <- speciesinfo$species[speciesinfo$key %in% as.numeric(available_ids)]
sp_options <- c("", available_species)

updateSelectizeInput(session, "speciesSelect", choices = sp_options, server = TRUE)
updateSelectizeInput(session, "speciesSelectThermal", choices = sp_options, server = TRUE)

# model_options <- c("MAXENT" = "maxnet")
# updateSelectizeInput(session, "modelSelect", choices = model_options, server = TRUE)


# Tab actions ----
# Set first tab
active_tab <- reactiveValues()
active_tab$current <- "species"
  
# Observe tab changes
observeEvent(input$jsValue, {
  mdebug("New tab active")
  # If there is a new value:
  if (active_tab$current != input$jsValue$id) {
    # output$mainMap <- renderLeaflet({eval(parse(text = paste0("map_", 
    #                                                          input$jsValue$id)))})
    
    # Update current status
    active_tab$current <- input$jsValue$id
    
    # Temporary workaround while other features will be added!
    if (!active_tab$current %in% c("species", "thermal", "habitat")) {
      shinyalert::shinyalert("Feature not available", "For now only species distribution maps are available.", type = "info")
      active_tab$current <- "species"
      session$sendCustomMessage("backToTab", "nothing")
    }
    #
  }
})

# Observe first input change
input_state <- reactiveValues(status = 0)
bindEvent(observe({input_state$status <- 1}), input$speciesSelect,
          once = TRUE, ignoreInit = TRUE)
bindEvent(observe({input_state$status <- 2}), input$speciesSelectThermal,
          once = TRUE, ignoreInit = TRUE)
bindEvent(observe({input_state$status <- 3}), input$habitatSelect,
          once = TRUE, ignoreInit = TRUE)
# bindEvent(observe({input_state$status <- 4}), input$speciesSelectThermal,
#           once = TRUE, ignoreInit = TRUE)

# Create a reactive for titles
title_state <- reactiveValues()
title_state$current <- "empty"

base_list <- list(
  tableA = "Select a map to start",
  graph = "",
  tableB = "",
  modelTitle = ""
)

observe({
  session$sendCustomMessage("showContext", "nothing")
}) %>%
  bindEvent(input$mainMap_draw_new_feature)

observe({
  if (title_state$current != active_tab$current) {
    session$sendCustomMessage("removeContext", "nothing")
    # Species condition
    if (active_tab$current == "species") {
      if (input$speciesSelect != "") {
        title_state$current <- "species"
        title_state$to_print <- list(
          tableA = "Model metrics",
          graph = "Response curves",
          tableB = "Variables importance",
          modelTitle = "Model explanation"
        )
      } else {
        title_state$to_print <- base_list
      }
    }
    
    # Thermal condition
    if (active_tab$current == "thermal") {
      if (input$speciesSelectThermal != "") {
        title_state$current <- "thermal"
        title_state$to_print <- list(
          tableA = "Thermal ranges",
          graph = "Thermal ranges (density)",
          tableB = "Area within thermal range",
          modelTitle = "Model explanation"
        )
      } else {
        title_state$to_print <- base_list
      }
    }
    
    # Habitat condition
    if (active_tab$current == "habitat") {
      if (input$habitatSelect != "") {
        title_state$current <- "habitat"
        title_state$to_print <- list(
          tableA = "Model metrics",
          graph = "Histogram",
          tableB = "Habitat metrics",
          modelTitle = "Model explanation"
        )
      } else {
        title_state$to_print <- base_list
      }
    }
    
    # Diversity condition
    if (active_tab$current == "diversity") {
      if (input$speciesSelect != "") {
        title_state$current <- "species"
        title_state$to_print <- list(
          tableA = "Model metrics",
          graph = "Response curves",
          tableB = "Variables importance",
          modelTitle = "Model explanation"
        )
      } else {
        title_state$to_print <- base_list
      }
    }
  }
}) %>%
  bindEvent(c(input_state$status, active_tab$current))



# Print titles ----
output$tableATitle <- renderText({title_state$to_print$tableA})
output$graphTitle <- renderText({title_state$to_print$graph})
output$tableBTitle <- renderText({title_state$to_print$tableB})
output$textTitle <- renderText({title_state$to_print$modelTitle})




## Species ----
# Title/context text
output$selectedSpecies <- renderText({
  input$speciesSelect
})

output$contextSpecies <- renderText({
  selinf <- speciesinfo[speciesinfo$species == input$speciesSelect,]
  if (input$speciesSelect != "") {
    spmodinfo <- jsonlite::read_json(glue::glue("data/maps/taxonid={selinf$key}/model=inteval/taxonid={selinf$key}_model=inteval_what=log.json"))
  } else {
    spmodinfo <- NULL
  }

  modinfo <- verify_posteval(spmodinfo)

  nrec <- modinfo$nrec
  neval <- modinfo$neval
  tenvstat <- modinfo$tenvstat
  tenvval <- modinfo$tenvval
  glue::glue(
      "<b>Phylum:<\u002fb> {selinf$phylum} > <b>Order:<\u002fb> {selinf$order} > <b>Family:<\u002fb> {selinf$family} <br>
      <b>AphiaID:<\u002fb> <a style = 'text-decoration: none; color: #07A5F0;' target='_blank' href = 'https://www.marinespecies.org/aphia.php?p=taxdetails&id={selinf$key}'>{selinf$key}<\u002fa><br><br>
    <b>Number of records:<\u002fb> {nrec} <br>
    <b>Number of records for independent evaluation:<\u002fb> {neval} <br><br>
    <b>Additional info:<\u002fb> All inside thermal envelope? {tenvstat} ({tenvval}%)"
  )
})

output$contextSpeciesThermal <- renderText({
  selinf <- speciesinfo[speciesinfo$species == input$speciesSelectThermal,]
  if (input$speciesSelectThermal != "") {
    spmodinfo <- jsonlite::read_json(glue::glue("data/maps/taxonid={selinf$key}/model=inteval/taxonid={selinf$key}_model=inteval_what=log.json"))
  } else {
    spmodinfo <- NULL
  }
  nrec <- unlist(spmodinfo$model_fit_points)
  glue::glue(
      "<b>Phylum:<\u002fb> {selinf$phylum} > <b>Order:<\u002fb> {selinf$order} > <b>Family:<\u002fb> {selinf$family} <br>
      <b>AphiaID:<\u002fb> <a style = 'text-decoration: none; color: #07A5F0;' target='_blank' href = 'https://www.marinespecies.org/aphia.php?p=taxdetails&id={selinf$key}'>{selinf$key}<\u002fa><br><br>
    <b>Number of records:<\u002fb> {nrec} <br>"
  )
})

speciespts <- reactive({
  if (active_tab$current == "species") {
    sel_species <- input$speciesSelect
  }
  if (active_tab$current == "thermal") {
    sel_species <- input$speciesSelectThermal
  }
  spkey <- speciesinfo$key[speciesinfo$species == sel_species]
  pts <- arrow::read_parquet(paste0("data/maps/taxonid=", spkey, "/model=inteval/taxonid=", spkey, "_model=inteval_what=fitocc.parquet"))[,1:2]
  colnames(pts) <- c("longitude", "latitude")
  pts
})

maskstate <- reactiveVal(TRUE)
observe({
  mdebug("Mask JS")
  maskstate(!maskstate())
}) %>% bindEvent(input$jsMask)

observe({
  mdebug("Changing options")
  spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
  logf <- jsonlite::read_json(paste0("data/maps/taxonid=",spkey,"/model=inteval/taxonid=",spkey,"_model=inteval_what=log.json"))

  mod_names <- names(logf$model_posteval)[unlist(lapply(logf$model_posteval, function(x) if (length(x) > 0) TRUE else FALSE))]
  available_models <- mod_names[!grepl("niche", mod_names)]
  available_models <- gsub("maxent", "maxnet", available_models)
  available_models <- gsub("rf", "rf_classification_ds", available_models)
  
  if (any(grepl(substr(input$modelSelect,1,3), available_models))) {
    model_inuse <- input$modelSelect
  } else {
    priority <- c("ensemble", "maxnet", "rf_classification_ds", "xgboost", "glm")
    model_inuse <- priority[priority %in% available_models][1]
  }

  names_options <- dplyr::case_when(
      available_models == "maxnet" ~ "MAXENT",
      available_models == "rf_classification_ds" ~ "Random Forest",
      available_models == "glm" ~ "GLM",
      available_models == "xgboost" ~ "XGboost",
      available_models == "ensemble" ~ "Ensemble",
      .default = available_models
  )

  names(available_models) <- names_options
  updateSelectInput(session, "modelSelect", choices = available_models, selected = model_inuse)
}) %>% bindEvent(input$speciesSelect, ignoreInit = T)

files_inuse <- reactiveValues(file_a = NULL,
                              file_b = NULL)
model_inuse <- reactiveValues(model = NULL)

# Change the MAP reactive
speciesmap <- reactive({
  
  mdebug("Executing map")
  mdebug(active_tab$current)
  
  sp_info <- list(
    species = "",
    model = "",
    scenario = "",
    decade = "",
    spkey = ""
  )

  if (active_tab$current == "species") {
    sp_info$species <- input$speciesSelect
    sp_info$model <- input$modelSelect
    sp_info$scenario <- tolower(input$scenarioSelect)
    sp_info$decade <- ifelse(is.null(input$periodSelect), NULL,
                    ifelse(input$periodSelect == 2050, "dec50", "dec100"))
    sp_info$spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
  }
  if (active_tab$current == "thermal") {
    sp_info$species <- input$speciesSelectThermal
    sp_info$scenario <- tolower(input$scenarioSelectThermal)
    sp_info$decade <- ifelse(is.null(input$periodSelectThermal), NULL,
                    ifelse(input$periodSelectThermal == 2050, "dec50", "dec100"))
    sp_info$spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelectThermal]
  }
  if (active_tab$current == "habitat") {
    sp_info$habitat <- input$habitatSelect
    sp_info$scenario <- tolower(input$scenarioSelectHabitat)
    sp_info$decade <- ifelse(is.null(input$periodSelectHabitat), NULL,
                    ifelse(input$periodSelectHabitat == 2050, "dec50", "dec100"))
  }
  
  basepath <- paste0("data/maps/taxonid=", sp_info$spkey,
                     "/model=inteval/predictions/")
  
  if (active_tab$current == "species") {
    mdebug("Executing species map")
    if (sp_info$species != "") {
      logf <- jsonlite::read_json(paste0("data/maps/taxonid=", sp_info$spkey,
                                         "/model=inteval/taxonid=", sp_info$spkey, "_model=inteval_what=log.json"))
      mod_names <- names(logf$model_posteval)[unlist(lapply(logf$model_posteval,
                                                            function(x) if (length(x) > 0) TRUE else FALSE))]
      available_models <- mod_names[!grepl("niche", mod_names)]
      available_models <- gsub("maxent", "maxnet", available_models)
      available_models <- gsub("rf", "rf_classification_ds", available_models)
      
      if (any(grepl(substr(sp_info$model,1,3), available_models))) {
        model_inuse$model <- sp_info$model
      } else {
        priority <- c("ensemble", "maxnet", "rf_classification_ds", "xgboost", "glm")
        model_inuse$model <- sp_info$model <- priority[priority %in% available_models][1]
      }
    }
    
    mdebug(paste("In use species", sp_info$species, sp_info$model,
                 sp_info$scenario, collapse = ","))
    mdebug(paste0(basepath, "taxonid=", sp_info$spkey, "_model=inteval", "_method=",
                  sp_info$model, "_scen=", sp_info$scenario, "_", sp_info$decade, "_cog.tif"))
    
    side_select <- input$sideSelect
    
    if (sp_info$scenario == "current") {
      file_a <- paste0(basepath, "taxonid=", sp_info$spkey, "_model=inteval", 
                       "_method=", sp_info$model, "_scen=current_cog.tif")
      file_b <- NULL
    } else {
      if (side_select) {
        file_a <- paste0(basepath, "taxonid=", sp_info$spkey, "_model=inteval", 
                         "_method=", sp_info$model, "_scen=current_cog.tif")
        file_b <- paste0(basepath, "taxonid=", sp_info$spkey, "_model=inteval", 
                         "_method=", sp_info$model, "_scen=", sp_info$scenario, 
                         "_", sp_info$decade, "_cog.tif")
      } else {
        file_a <- paste0(basepath, "taxonid=", sp_info$spkey, "_model=inteval",
                         "_method=", sp_info$model, "_scen=", sp_info$scenario,
                         "_", sp_info$decade, "_cog.tif")
        file_b <- NULL
      }
    }

    files_inuse$file_a <- file_a
    files_inuse$file_b <- file_b
    
    if (sp_info$species == "") {
      m <- m %>%
        leafem::addFgb(file = "data/studyarea.fgb", fillColor = "#184e77", fill = T)
    } else {
      m <- m %>%
        addCircleMarkers(data = speciespts(),
                         clusterOptions = NULL,#markerClusterOptions(),
                         group = "Points",
                         weight = 2,
                         radius = 2,
                         opacity = 1,
                         fillOpacity = 0.1,
                         color = "black") %>% 
        hideGroup("Points") %>%
        addEasyButton(easyButton(
          icon = "fa-eye", title = "Activate/deactivate native mask",
          onClick = JS('
          function(btn, map) {
            var new_state = {id: "newstate", nonce: Math.random()};
            Shiny.onInputChange("jsMask", new_state);
          }
        '))
        ) %>%
        htmlwidgets::onRender('
                            LeafletWidget.methods.removeImage = function(layerId) {
                              this.layerManager.removeLayer(null, layerId);
                            }
                            ')
      
      render_fun <- "
              function(el, x) {
                // Sleep function
                function sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }
        
                // Example usage of the sleep function
                async function exampleFunction() {
                    //console.log('Start');
        
                    await sleep(3000); // Sleep for 2000 milliseconds (2 seconds)
                    
        
                    //console.log('End after 2 seconds');
                }
                // Flag to ensure exampleFunction only runs once
                let functionCalled = false;

                //console.log('calling fun');
                  exampleFunction();

                this.whenReady(function(map){
                  if (!functionCalled) {
                  functionCalled = true;
                  
                  console.log('sending shiny');
                  Shiny.onInputChange('enableMaskJS', Math.random());
                  }
                })
            }
                        "
      
      if (sp_info$scenario != "current" & side_select) {
        
        m <- m %>%
          addMapPane("left", zIndex = 0) %>%
          addMapPane("right", zIndex = 0) %>%
          removeTiles("baseid") %>%
          removeLayersControl() %>%
          addTiles(group = "Open Street", layerId = "leftbaseid",
                   options = pathOptions(pane = "left")) %>%
          addGeotiff(file = file_a,
                     opacity = 1,
                     colorOptions = colorOptions(
                       palette = rev(c("#7d1500", "#da4325", "#eca24e", "#e7e2bc", "#5cc3af", "#0a6265")),
                       domain = c(0, 100),
                       na.color = NA
                     ),
                     options = pathOptions(pane = "left"), autozoom = F) %>%
          addTiles(group = "Open Street B", layerId = "rightbaseid",
                   options = pathOptions(pane = "right")) %>%
          addGeotiff(file = file_b,
                     opacity = 1,
                     colorOptions = colorOptions(
                       palette = rev(c("#7d1500", "#da4325", "#eca24e", "#e7e2bc", "#5cc3af", "#0a6265")),
                       domain = c(0, 100),
                       na.color = NA
                     ),
                     options = pathOptions(pane = "right"), autozoom = F) %>%
          addSidebyside(layerId = "sidecontrols",
                        rightId = "rightbaseid",
                        leftId = "leftbaseid") %>%
          htmlwidgets::onRender(render_fun)
        
      } else {
        
        m <- m %>%
          addGeotiff(file = file_a,
                     opacity = 1,
                     colorOptions = colorOptions(
                       palette = rev(c("#7d1500", "#da4325", "#eca24e", "#e7e2bc", "#5cc3af", "#0a6265")),
                       domain = c(0, 100),
                       na.color = NA
                     ), autozoom = F) %>%
          addPmToolbar(
            toolbarOptions = pmToolbarOptions(drawMarker = FALSE,
                                              drawPolyline = FALSE,
                                              drawCircle = FALSE,
                                              cutPolygon = FALSE,
                                              position = "topleft"),
            drawOptions = pmDrawOptions(snappable = FALSE, allowSelfIntersection = FALSE),
            editOptions = pmEditOptions(preventMarkerRemoval = FALSE, draggable = TRUE)
          ) %>%
          htmlwidgets::onRender(render_fun)
      }
    }
  }
  if (active_tab$current == "thermal") {
    
    if (sp_info$species == "") {
      m <- m %>%
         leafem::addFgb(file = "data/studyarea.fgb", fillColor = "#184e77", fill = T)
    }
    
  }
  if (active_tab$current == "habitat") {
    if (sp_info$habitat == "") {
      m <- m %>%
         leafem::addFgb(file = "data/studyarea.fgb", fillColor = "#184e77", fill = T)
    } else {
      print(sp_info);stop("a")
      sel_habitat <- paste0("data/habitats/habitat=", sp_info$habitat, "_model=inteval_scen=", 
                            ifelse(sp_info$scenario == "current", "current",
                                    paste0(sp_info$scenario, "_", sp_info$decade)),
                            "_cog.tif") 

      m <- m %>%
          addGeotiff(file = sel_habitat,
                     opacity = 1,
                     colorOptions = colorOptions(
                       palette = rev(c("#7d1500", "#da4325", "#eca24e", "#e7e2bc", "#5cc3af", "#0a6265")),
                       #domain = c(0, 100),
                       na.color = NA
                     ), autozoom = F) %>%
          addPmToolbar(
            toolbarOptions = pmToolbarOptions(drawMarker = FALSE,
                                              drawPolyline = FALSE,
                                              drawCircle = FALSE,
                                              cutPolygon = FALSE,
                                              position = "topleft"),
            drawOptions = pmDrawOptions(snappable = FALSE, allowSelfIntersection = FALSE),
            editOptions = pmEditOptions(preventMarkerRemoval = FALSE, draggable = TRUE)
          )

    }
  }
  
  # Return object
  m
  
})


# For thermal data, we have a shapefile. So, what we do is to just update the proxy map
thermal_data <- reactive({
  mdebug("Changing thermal reactive")
  if (input$speciesSelectThermal != "" & active_tab$current == "thermal") {
  scenario <- tolower(input$scenarioSelectThermal)
  decade <- ifelse(is.null(input$periodSelectThermal), NULL,
                    ifelse(input$periodSelectThermal == 2050, "dec50", "dec100"))
  spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelectThermal]

  thermal_envelope <- sfarrow::st_read_parquet(
        paste0("../mpaeu_sdm/results/taxonid=", spkey, "/model=inteval/predictions/taxonid=", spkey, "_model=inteval_what=thermenvelope.parquet")
      )

  thermal_envelope_current <- thermal_envelope[1,]

  if (tolower(input$scenarioSelectThermal) != "current") {
    nams_thermal_envelope <- c("current", paste0(
                rep(c("ssp126", "ssp245", "ssp370", "ssp460", "ssp585"), each = 2), "_", rep(c("dec50", "dec100"), 5)
        ))
  nams_thermal_envelope <- which(grepl(paste0(scenario, "_", decade), nams_thermal_envelope))
  thermal_envelope_future <- thermal_envelope[nams_thermal_envelope,]
  } else {
    thermal_envelope_future <- NULL
  }

  list(current = thermal_envelope_current,
       future = thermal_envelope_future)
  } else {NULL}

})

observe({

  mdebug("Processing thermal update")
  proxy <- leafletProxy("mainMap")
  
  proxy <- proxy %>% 
    clearMarkers() %>%
    clearShapes() %>%
    leafem::addFeatures(thermal_data()$current, layerId = "Current", group = "Current") 
  
  if (!is.null(thermal_data()$future)) {
  proxy <- proxy %>% 
          leafem::addFeatures(thermal_data()$future, color = "#ffcc00", layerId = "Future", group = "Future") %>%
          addLayersControl(
              overlayGroups = c("Points", "Current", "Future"),
              baseGroups = c("Open Street Maps", "CartoDB", "CartoDB Dark"),
              options = layersControlOptions(collapsed = T),
              position = "bottomright"
            )
  }

  proxy %>%
    addCircleMarkers(data = speciespts(),
                      clusterOptions = NULL,#markerClusterOptions(),
                      group = "Points",
                      weight = 2,
                      radius = 2,
                      opacity = 1,
                      fillOpacity = 0.1,
                      color = "black") %>%
    hideGroup("Points")

}) %>%
  bindEvent(thermal_data(), ignoreInit = F)





# Turn mask on or off
observe({
  req(input$speciesSelect)
  mdebug("Processing mask")
  proxy <- leafletProxy("mainMap")
  spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
  mask_layer <- paste0("data/maps/taxonid=", spkey, "/model=inteval/predictions/taxonid=", spkey, "_model=inteval_mask_cog.tif")

  if (!maskstate()) {
    mdebug("Mask deactivated")
    proxy %>% removeImage(layerId = "mapMask") %>%
        removeControl(layerId = "maskControl")
  } else {
    mdebug("Mask activated")
    proxy %>% addGeotiff(file = mask_layer,
             opacity = 1,
             #resolution = 50,
             layerId = "mapMask",
             bands = 1,
             colorOptions = colorOptions(
               palette = c("#aad3df", "#0a626500"),
               domain = c(0,1),
               na.color = NA
             ), autozoom = F) %>%
      addControl(tags$div(HTML('<span style="font-weight: bold; color: #184e77;">Mask active<\u002fspan>')),
                       position = "topright", layerId = "maskControl")
  }

})

# Set the new rendered map
observe({
  mdebug("Setting new map")
  current_map(speciesmap())
}) %>%
  bindEvent(speciesmap())

# Thermal
output$selectedSpeciesThermal <- renderText({
  input$speciesSelectThermal
}) %>%
  bindEvent(input$speciesSelectThermal, ignoreInit = T)


# # Create reactives for species/tab info
# react_species <- reactiveValues(status = 0)
# react_thermal <- reactiveValues(status = 0)
# react_habitat <- reactiveValues(status = 0)
# react_diversity <- reactiveValues(status = 0)
# 
# observe({
#   react_species$plot_raster <- rast("data/maps/species/key=100803/mv1_pr/lasso_naive/predictions/mv1_pr_lasso_naive_key100803_basevars_current.tif")
#   react_species$status <- react_species$status + 1
# }) %>%
#   bindEvent(input$speciesSelect, ignoreInit = TRUE)

# TODO: add habitat and diversity

 # context_leaf_info <- reactiveValues(haveinfo = FALSE)
  
  
  
## Contextual info ----
continfo <- reactiveValues()

observe({
  
  if (active_tab$current == "species") {
    req(!is.null(model_inuse$model))
    spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
    
    basepath <- paste0("data/maps/taxonid=", spkey, "/model=inteval/metrics/")
    
    # Table 1
    metrics <- arrow::read_parquet(
      paste0(basepath, "taxonid=", spkey, "_model=inteval_method=", model_inuse$model,#input$modelSelect, 
      "_what=cvmetrics.parquet")
    )
    if (model_inuse$model == "ensemble") {
      metrics <- metrics %>% filter(what == "mean") %>% filter(origin == "avg_fit") %>% select(-origin, -what)
    }
    metrics_mean <- metrics %>%
      summarise(across(1:ncol(metrics), function(x) {round(mean(x), 2)}))
    metrics_mean <- metrics_mean %>%
      tidyr::pivot_longer(cols = 1:ncol(metrics_mean), names_to = "Metric", values_to = "Mean of 5 folds") %>%
      mutate(Metric = toupper(Metric))
    metrics_sd <- metrics %>%
      summarise(across(1:ncol(metrics), function(x) {round(sd(x), 2)}))
    metrics_sd <- metrics_sd %>%
      tidyr::pivot_longer(cols = 1:ncol(metrics_sd), names_to = "Metric", values_to = "SD") %>%
      mutate(Metric = toupper(Metric))
    metrics_mean <- left_join(metrics_mean, metrics_sd, by = "Metric")
    # metrics_mean <- metrics_mean %>%
    #   filter(Metric %in% c("AUC", "CBI", "PR", "TSS_P10"))
    continfo$tableA <- metrics_mean

    # Table 2
    varimp <- arrow::read_parquet(
      paste0(basepath, "taxonid=", spkey, "_model=inteval_method=", model_inuse$model,#input$modelSelect,
      "_what=varimportance.parquet")
    )
    continfo$tableB <- varimp
    
    # Graph
    response_curves <- arrow::read_parquet(
      paste0(basepath, "taxonid=", spkey, "_model=inteval_method=", model_inuse$model,#input$modelSelect,
      "_what=respcurves.parquet")
    )
    # response_curves <- response_curves %>%
    #   group_by(variable) %>%
    #   mutate(base = scale(base))
    # pa <- ggplot(response_curves) +
    #   geom_line(aes(x = base, y = response, color = variable)) +
    #   theme_light() +
    #   xlab("Value (scaled)") + ylab("Response")
    
    continfo$plotA <- gen_plotly_resp(response_curves)
    
    # Text
    continfo$text[[1]] <- paste("Model explanation -",
                                switch(strtrim(input$modelSelect, 3),
                                       brt = "BRT",
                                       las = "LASSO",
                                       ela = "elasticnet",
                                       max = "MAXENT",
                                       rf_ = "Random Forest",
                                       glm = "GLM",
                                       gam = "GAM",
                                       xgb = "XGBoost",
                                       lgb = "LightGBM",
                                       ens = "Ensemble"))
    
    context_file <- jsonlite::read_json("context_info.json")
    continfo$text[[2]] <- switch(strtrim(input$modelSelect, 3),
       brt = unlist(context_file$models[["brt"]]),
       las = unlist(context_file$models[["lasso"]]),
       ela = unlist(context_file$models[["elasticnet"]]),
       max = unlist(context_file$models[["maxent"]]),
       rf_ = unlist(context_file$models[["rf"]]),
       glm = unlist(context_file$models[["glm"]]),
       gam = unlist(context_file$models[["gam"]]),
       xgb = unlist(context_file$models[["xgboost"]]),
       lgb = unlist(context_file$models[["lightgbm"]]),
       ens = unlist(context_file$models[["ensemble"]]))
    
  }

  if (active_tab$current == "thermal") {
    
     spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelectThermal]
    
    thermal_envelope <- jsonlite::read_json(
        paste0("../mpaeu_sdm/results/taxonid=", spkey, "/model=inteval/metrics/taxonid=", spkey, "_model=inteval_what=thermmetrics.json"))
    
    thermal_envelope$limits[[1]]$decade <- NA
    limits <- data.frame(do.call("rbind", thermal_envelope$limits))
    colnames(limits) <- c("Q5%", "Q50%", "Q95%", "Mean", "SD", "Scenario", "Decade")
    limits <- limits[,c(6,7,1:5)]
    
    thermal_envelope$areas[[1]]$decade <- NA
    areas <- data.frame(do.call("rbind", thermal_envelope$areas))
    colnames(areas) <- c("Area (km²)", "Scenario", "Decade")
    areas <- areas[,c(2,3,1)]

    sst <- rast(paste0("data/thetao_baseline_",thermal_envelope$sst_depth[[1]],"_mean_cog.tif"))
    sst_data <- terra::extract(sst, speciespts()[,1:2], ID = F)
    colnames(sst_data) <- "sst"

    limits_ob <- data.frame(
  what = c("Median current", "Q5%", "Q95%", "Median SSP1(2.6)-2100",
           "Median SSP2(4.5)-2100", "Median SSP3(7.0)-2100",
           "Median SSP4(6.0)-2100", "Median SSP5(8.5)-2100"),
  values = unlist(c(limits$`Q50%`[1],limits$`Q5%`[1], limits$`Q95%`[1],
                    limits$`Q50%`[c(3,5,7,9,11)]))
)

  p <- ggplot() +
  geom_density(data = sst_data, aes(x = sst), fill = "grey90", color = "grey60") +
  geom_vline(data = limits_ob, aes(xintercept = values, color = what, linetype = what)) +
  scale_linetype_manual(values = c(rep(1,6), 2,2), name = NULL) +
  scale_color_manual(values = c(c("#E01156", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5", "#084594"),
                                "grey50", "grey70"), name = NULL) +
  xlab("Sea temperature (°C)") + ylab("Density") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0.1,0)) +
  labs(caption = "Median values extracted using the current distribution.") +
  theme_light() +
  theme(
    legend.key.spacing.y = ggplot2::unit(0.2, "lines"),
    panel.grid = element_blank()
  )

    continfo$tableA <- limits
    continfo$tableB <- areas
    continfo$plotA <- plotly::ggplotly(p)
    continfo$text[[1]] <- "How this data is extracted?"
    continfo$text[[2]] <- "Short explanation."
  }
  
}) %>%
  bindEvent(c(input$speciesSelect, input$modelSelect,
              input$speciesSelectThermal), ignoreInit = TRUE)

output$tableA <- DT::renderDT({
  #continfo$tableA
   DT::datatable(continfo$tableA, options = list(paging =TRUE, pageLength = 5))
}) %>%
  bindEvent(continfo$tableA)

output$plotA <- renderPlotly({
  continfo$plotA
}) %>%
  bindEvent(continfo$plotA)

output$tableB <- DT::renderDT({
  DT::datatable(continfo$tableB, options = list(paging =TRUE, pageLength = 5))
}) %>%
  bindEvent(continfo$tableB)

output$textTitle <- renderText({
  continfo$text[[1]]
}) %>%
  bindEvent(continfo$text)

output$textModel <- renderText({
  continfo$text[[2]]
}) %>%
  bindEvent(continfo$text)


### Downloads ----
output$downloadSpeciesReport <- downloadHandler(
    filename = function() {
      spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
      paste0("taxonid=", spkey,"_date=", format(Sys.time(), "%Y-%m-%d_%H-%M%Z"), "_report.pdf")
    },
    content = function(file) {
      # showModal(modalDialog("Preparing report. This might take a while.", footer=NULL))
      shinyalert(
            title = "Preparing your download",
            text = "This may take a while. You can keep using the app.",
            size = "xs",  closeOnEsc = TRUE, closeOnClickOutside = TRUE, html = FALSE, type = "info",
            showConfirmButton = TRUE, showCancelButton = FALSE, confirmButtonText = "OK", confirmButtonCol = "#184E77",
            timer = 0, imageUrl = "", animation = TRUE)
      #on.exit(removeModal())
      on.exit(shinyalert::closeAlert())
      spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
      model <- input$modelSelect
      tdir <- tempdir()
      outfolder <- fs::dir_create(paste0(tdir, "/temp_aphiaid_", spkey, "_", sample(1:10000, 1)))
      mdebug("getting wd")
      basepath <- getwd()
      mdebug(basepath)
      rep_result <- try(gen_quarto_report(file, outfolder, basepath, spkey, model))
      if (inherits(rep_result, "try-error")) {
        pdf(file)
        plot.new()
        text(x = 0.5, y = 0.5, labels = "Report failed. Try again or contact the OBIS team: helpdesk@obis.org")
        dev.off()
      }
      if (dir.exists(outfolder)) fs::dir_delete(outfolder)
    }
  )

# output$downloadModelContent <- downloadHandler(
#     filename = function() {
#       spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
#       paste0("taxonid=", spkey,"_date=", format(Sys.time(), "%Y-%m-%d-%H:%M%Z"), "_report.pdf")
#     },
#     content = function(file) {
#       # showModal(modalDialog("Preparing report. This might take a while.", footer=NULL))
#       shinyalert(
#             title = "Preparing your download",
#             text = "This may take a while. You can keep using the app.",
#             size = "xs",  closeOnEsc = TRUE, closeOnClickOutside = TRUE, html = FALSE, type = "info",
#             showConfirmButton = TRUE, showCancelButton = FALSE, confirmButtonText = "OK", confirmButtonCol = "#184E77",
#             timer = 0, imageUrl = "", animation = TRUE)
#       #on.exit(removeModal())
#       on.exit(shinyalert::closeAlert())
#       spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
#       model <- input$modelSelect
#       outfolder <- fs::dir_create(paste0("temp_aphiaid_", tg_species, "_", sample(1:10000, 1)))
#       rep_result <- try(gen_quarto_report(file, outfolder, spkey, model))
#       if (inherits(rep_result, "try-error")) {
#         pdf(file)
#         plot.new()
#         text(x = 0.5, y = 0.5, labels = "Report failed. Try again or contact the OBIS team: helpdesk@obis.org")
#         dev.off()
#       }
#       if (dir.exists(outfolder)) fs::dir_delete(outfolder)
#     }
#   )
# 
# output$downloadModelCode <- downloadHandler(
#     filename = function() {
#       spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
#       paste0("taxonid=", spkey,"_date=", format(Sys.time(), "%Y-%m-%d-%H:%M%Z"), "_report.pdf")
#     },
#     content = function(file) {
#       # showModal(modalDialog("Preparing report. This might take a while.", footer=NULL))
#       shinyalert(
#             title = "Preparing your download",
#             text = "This may take a while. You can keep using the app.",
#             size = "xs",  closeOnEsc = TRUE, closeOnClickOutside = TRUE, html = FALSE, type = "info",
#             showConfirmButton = TRUE, showCancelButton = FALSE, confirmButtonText = "OK", confirmButtonCol = "#184E77",
#             timer = 0, imageUrl = "", animation = TRUE)
#       #on.exit(removeModal())
#       on.exit(shinyalert::closeAlert())
#       spkey <- speciesinfo$key[speciesinfo$species == input$speciesSelect]
#       model <- input$modelSelect
#       outfolder <- fs::dir_create(paste0("temp_aphiaid_", tg_species, "_", sample(1:10000, 1)))
#       rep_result <- try(gen_quarto_report(file, outfolder, spkey, model))
#       if (inherits(rep_result, "try-error")) {
#         pdf(file)
#         plot.new()
#         text(x = 0.5, y = 0.5, labels = "Report failed. Try again or contact the OBIS team: helpdesk@obis.org")
#         dev.off()
#       }
#       if (dir.exists(outfolder)) fs::dir_delete(outfolder)
#     }
#   )

### Extra info ----
# TODO: convert to function

output$extraPlotA <- renderPlot({
  if (input$extraButton != 0 && input$extraButton %% 2 != 0) {
    bias <- readRDS("data/maps/taxonid=100803/model=inteval/metrics/taxonid=100803_model=inteval_what=biasmetrics.rds")
    k <- bias$k_stat
    l <- bias$l_stat
    # class(k) <- c("envelope", class(k))
    # class(l) <- c("envelope", class(l))
    par(mfrow = c(2, 1))
    plot(k, main = "Spatial bias - K-function")
    plot(l, main = "L-function")
  } else {
    plot.new()
  }
})

output$extraPlotB <- renderPlot({
  if (input$extraButton != 0 && input$extraButton %% 2 != 0) {
    shape <- terra::rast("data/maps/taxonid=100803/model=inteval/predictions/taxonid=100803_model=inteval_what=shape_cog.tif")[[1]]
    mess <- terra::rast("data/maps/taxonid=100803/model=inteval/predictions/taxonid=100803_model=inteval_what=mess_cog.tif")[[1]]
    cl <- c("#FDE725", "#B3DC2B", "#6DCC57", "#36B677", "#1F9D87", "#25818E", "#30678D", "#3D4988", "#462777", "#440154")
    cl_mess <- c("#1b9e77", "#d95f02", "#7570b3", "#e7298a", "#66a61e", "#e6ab02", "#a6761d", "#666666")
    par(mfrow = c(2, 1))
    plot(shape, main = "Extrapolation - SHAPE", col = cl)
    plot(mess, main = "Extrapolation - MESS", , col = cl_mess)
  } else {
    plot.new()
  }
})


### Drawing context info ----
continfo_leaf <- reactiveValues()

observe({
  
  coords <- lapply(input$mainMap_draw_new_feature$geometry$coordinates[[1]], function(x){
    paste(x, collapse = " ")
  })
  
  wkt <- paste("POLYGON ((", paste(coords, collapse = ","),"))")
  
  vect_obj <- terra::vect(wkt)
  
  terra::crs(vect_obj) <- "EPSG:4326"
  
  if (active_tab$current == "species") {
    mdebug(paste("Active tab for data extraction:", active_tab$current))
    
    sp_info <- list(
        species = input$speciesSelect,
        model = input$modelSelect,
        scenario = tolower(input$scenarioSelect),
        decade = ifelse(is.null(input$periodSelect), NULL,
                    ifelse(input$periodSelect == 2050, "dec50", "dec100")),
        spkey = speciesinfo$key[speciesinfo$species == input$speciesSelect]
    )

    vals <- terra::extract(terra::rast(files_inuse$file_a), vect_obj)
    vals <- vals[,2]
    vals <- vals[!is.na(vals)]
    
    if (any(is.null(vals)) | any(is.na(vals))) {
      vals <- 0
    }
    
    p <- ggplot(data.frame(ROR = vals)) +
      geom_density(aes(x = ROR), fill = "#1a759f", color = NA) +
      xlab("Relative Occurrence Rate") +
      ylab(NULL) +
      theme_classic() +
      theme(axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.text.y = element_blank())
    
    continfo_leaf$density <- p
    
    continfo_leaf$text <- glue::glue(
      "<span style='font-size:larger;'><b>Selected area<\u002fb><\u002fspan> <br> 
    <b>Mean Relative Occurrence Rate:<\u002fb> {round(mean(vals), 2)} <br>
    <b>Standard deviation ROR:<\u002fb> {round(sd(vals), 2)} <br>
    <b>Total area:<\u002fb> {round(terra::expanse(vect_obj, unit = 'km'), 2)}km² <br><br>"
    )
  }
  
  
}) %>%
  bindEvent(input$mainMap_draw_new_feature)

output$contextMap <- renderPlot({
  continfo_leaf$density
}, height = 200, width = 200) %>%
  bindEvent(continfo_leaf$density)

output$contextMapText <- renderText({
  continfo_leaf$text
}) %>%
  bindEvent(continfo_leaf$text)
  
outputOptions(output, "contextMap", suspendWhenHidden = FALSE)



# Add mask to map ----
# observe({
#   mdebug("Mascara ativa")
#   print(input$jsMask)
#   leafletProxy("mainMap") %>%
#     removeTiles("baseid")
# }) %>%
#   bindEvent(input$jsMask)
</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(function(q, nm, val) {
    # Infer name, if possible
    if (nm == "") {
      tryCatch({
        nm <- rlang::as_name(q)
      }, error = function(e) {
        code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
        stop("ojs_define() could not create a name for the argument: ", code)
      })
    }
    .session$output[[nm]] <- val
    outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
    .session$sendCustomMessage("ojs-export", list(name = nm))
    NULL
  }, quos, nm, vars, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  invisible()
}
</script>
</p>
<!--html_preserve-->

<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"character","attributes":{},"value":["1.6.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.6.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["3.6.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["lib/3.6.0"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery-3.6.0.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquerylib"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.1.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["leaflet"]},{"type":"character","attributes":{},"value":["1.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/lib/leaflet"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet.js"]},{"type":"character","attributes":{},"value":["leaflet.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.2.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["leafletfix"]},{"type":"character","attributes":{},"value":["1.0.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/lib/leafletfix"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leafletfix.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.2.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["proj4"]},{"type":"character","attributes":{},"value":["2.6.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/plugins/Proj4Leaflet"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["proj4.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["2.2.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["Proj4Leaflet"]},{"type":"character","attributes":{},"value":["1.0.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/plugins/Proj4Leaflet"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["proj4leaflet.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["2.2.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["rstudio_leaflet"]},{"type":"character","attributes":{},"value":["1.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/lib/rstudio_leaflet"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rstudio_leaflet.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.2.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["leaflet-binding"]},{"type":"character","attributes":{},"value":["2.2.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/assets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["leaflet"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["2.2.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.8.1.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"character","attributes":{},"value":["1.6.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.6.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-css"]},{"type":"character","attributes":{},"value":["0.0.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/css"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables-crosstalk.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.33"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-binding"]},{"type":"character","attributes":{},"value":["0.33"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["0.33"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["3.5.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["lib/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.2.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"character","attributes":{},"value":["1.2.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/crosstalk.min.js"]},{"type":"character","attributes":{},"value":["css/crosstalk.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.2.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"character","attributes":{},"value":["1.6.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.6.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["plotly-binding"]},{"type":"character","attributes":{},"value":["4.10.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["plotly.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["plotly"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["4.10.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"character","attributes":{},"value":["1.6.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.6.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-css"]},{"type":"character","attributes":{},"value":["0.0.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/css"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables-crosstalk.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.33"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-binding"]},{"type":"character","attributes":{},"value":["0.33"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["0.33"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["3.5.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["lib/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.2.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"character","attributes":{},"value":["1.2.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/crosstalk.min.js"]},{"type":"character","attributes":{},"value":["css/crosstalk.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.2.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["font-awesome"]},{"type":"character","attributes":{},"value":["6.4.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fontawesome"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/all.min.css","css/v4-shims.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fontawesome"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.2"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->

<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68]}},"value":[{"type":"character","attributes":{},"value":["base","bslib","cachem","cli","colorspace","compiler","crosstalk","data.table","datasets","digest","dplyr","DT","evaluate","fansi","fastmap","fontawesome","generics","ggplot2","glue","graphics","grDevices","grid","gtable","htmltools","htmlwidgets","httpuv","httr","jquerylib","jsonlite","knitr","later","lazyeval","leaflet","leaflet.extras","leaflet.extras2","leaflet.providers","lifecycle","magrittr","memoise","methods","mime","munsell","pillar","pkgconfig","plotly","promises","purrr","R6","Rcpp","rlang","rmarkdown","rstudioapi","sass","scales","shiny","stats","tibble","tidyr","tidyselect","tools","utf8","utils","vctrs","viridisLite","withr","xfun","xtable","yaml"]},{"type":"character","attributes":{},"value":["4.3.1","0.7.0","1.0.8","3.6.2","2.1-0","4.3.1","1.2.1","1.15.4","4.3.1","0.6.35","1.1.4","0.33","0.23","1.0.6","1.1.1","0.5.2","0.1.3","3.5.1","1.7.0","4.3.1","4.3.1","4.3.1","0.3.5","0.5.8.1","1.6.4","1.6.15","1.4.7","0.1.4","1.8.8","1.45","1.3.2","0.2.2","2.2.2","1.0.0","1.2.2","2.0.0","1.0.4","2.0.3","2.0.1","4.3.1","0.12","0.5.1","1.9.0","2.0.3","4.10.4","1.3.0","1.0.2","2.5.1","1.0.12","1.1.3","2.26","0.16.0","0.4.9","1.3.0","1.8.1.1","4.3.1","3.2.1","1.3.1","1.2.1","4.3.1","1.2.4","4.3.1","0.6.5","0.4.2","3.0.0","0.43","1.8-4","2.3.8"]}]}]}
</script>
<!--/html_preserve-->


<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /container fluid -->



</body></html>